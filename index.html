<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>GeoCam Tracker Pro</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <style>
    :root { --primary: #0f172a; --accent: #3b82f6; }
    body { font-family: -apple-system, sans-serif; margin: 0; background: #f8fafc; color: #1e293b; }
    header { padding: 15px; background: var(--primary); color: white; text-align: center; }
    
    /* Video Container */
    #videoContainer { position: relative; width: 100%; max-width: 600px; margin: 10px auto; background: #000; border-radius: 12px; overflow: hidden; aspect-ratio: 4/3; }
    #preview { width: 100%; height: 100%; object-fit: cover; }
    .cam-controls { position: absolute; bottom: 10px; left: 10px; display: flex; gap: 5px; }
    
    .stats-overlay { display: flex; justify-content: space-around; background: white; padding: 15px; margin: 10px; border-radius: 12px; box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1); }
    .stat-box { text-align: center; }
    .stat-val { display: block; font-size: 1.2em; font-weight: bold; color: var(--accent); }
    
    .main-btns { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; padding: 0 10px; }
    button { padding: 12px; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; transition: 0.2s; }
    .btn-start { background: #22c55e; color: white; }
    .btn-stop { background: #ef4444; color: white; }
    .btn-share { background: var(--accent); color: white; grid-column: span 2; }
    
    #map { height: 300px; margin: 15px; border-radius: 12px; }
  </style>
</head>
<body>

<header>
  <h1>GeoCam Tracker</h1>
</header>

<div id="videoContainer">
  <video id="preview" autoplay muted playsinline></video>
  <div class="cam-controls">
    <button onclick="switchCamera('user')">ðŸ¤³ Selfie</button>
    <button onclick="switchCamera('environment')">ðŸ“· Back</button>
  </div>
</div>

<div class="stats-overlay">
  <div class="stat-box"><span>Speed</span><span id="speed" class="stat-val">0</span><small>km/h</small></div>
  <div class="stat-box"><span>Distance</span><span id="distance" class="stat-val">0.0</span><small>km</small></div>
  <div class="stat-box"><span>Time</span><span id="timer" class="stat-val">00:00</span></div>
</div>

<div class="main-btns">
  <button id="startBtn" class="btn-start">Start Journey & Video</button>
  <button id="stopBtn" class="btn-stop" disabled>Stop & Save</button>
  <button id="shareBtn" class="btn-share">ðŸ”— Copy Live Journey Link</button>
</div>

<div id="map"></div>

<script>
  let watchId, mediaRecorder, stream;
  let chunks = [];
  let tracking = false;
  let startTime;
  let totalDistance = 0;
  let lastCoord = null;
  let currentFacingMode = 'environment';

  const map = L.map('map').setView([0, 0], 15);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
  let path = L.polyline([], {color: '#3b82f6', weight: 6}).addTo(map);

  // --- Camera Logic ---
  async function initCamera(facingMode) {
    if (stream) stream.getTracks().forEach(track => track.stop());
    try {
      stream = await navigator.mediaDevices.getUserMedia({
        video: { facingMode: facingMode },
        audio: true
      });
      document.getElementById('preview').srcObject = stream;
      currentFacingMode = facingMode;
    } catch (err) {
      alert("Camera access denied or not found.");
    }
  }

  function switchCamera(mode) {
    initCamera(mode);
  }

  // --- Tracking Logic ---
  function startJourney() {
    tracking = true;
    startTime = Date.now();
    chunks = [];
    
    // Start Recording
    mediaRecorder = new MediaRecorder(stream);
    mediaRecorder.ondataavailable = e => chunks.push(e.data);
    mediaRecorder.onstop = saveVideo;
    mediaRecorder.start();

    // Start GPS
    watchId = navigator.geolocation.watchPosition(pos => {
      const { latitude, longitude, speed } = pos.coords;
      const currentSpeed = speed ? (speed * 3.6).toFixed(1) : 0;
      document.getElementById('speed').textContent = currentSpeed;

      if (lastCoord) {
        const d = calcDist(lastCoord.lat, lastCoord.lng, latitude, longitude);
        totalDistance += d;
        document.getElementById('distance').textContent = totalDistance.toFixed(2);
      }
      lastCoord = {lat: latitude, lng: longitude};
      path.addLatLng([latitude, longitude]);
      map.panTo([latitude, longitude]);
    }, null, { enableHighAccuracy: true });

    // Timer logic
    setInterval(() => {
      if(!tracking) return;
      const diff = Math.floor((Date.now() - startTime) / 1000);
      const m = Math.floor(diff/60).toString().padStart(2,'0');
      const s = (diff%60).toString().padStart(2,'0');
      document.getElementById('timer').textContent = `${m}:${s}`;
    }, 1000);
  }

  function stopJourney() {
    tracking = false;
    navigator.geolocation.clearWatch(watchId);
    mediaRecorder.stop();
    document.getElementById('startBtn').disabled = false;
    document.getElementById('stopBtn').disabled = true;
  }

  function saveVideo() {
    const blob = new Blob(chunks, { type: 'video/mp4' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `Journey_${new Date().getTime()}.mp4`;
    a.click();
  }

  function calcDist(lat1, lon1, lat2, lon2) {
    const R = 6371;
    const dLat = (lat2-lat1) * Math.PI/180;
    const dLon = (lon2-lon1) * Math.PI/180;
    const a = Math.sin(dLat/2)**2 + Math.cos(lat1*Math.PI/180)*Math.cos(lat2*Math.PI/180)*Math.sin(dLon/2)**2;
    return 2 * R * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
  }

  // --- Sharing Logic ---
  document.getElementById('shareBtn').onclick = () => {
    // We encode the current journey data into the URL so someone opening it sees the stats
    const journeyData = {
      d: totalDistance.toFixed(2),
      s: document.getElementById('speed').textContent,
      t: document.getElementById('timer').textContent,
      loc: lastCoord
    };
    const encodedData = btoa(JSON.stringify(journeyData));
    const shareUrl = `${window.location.origin}${window.location.pathname}?data=${encodedData}`;
    
    navigator.clipboard.writeText(shareUrl);
    alert("Journey link copied to clipboard! Send this to a friend.");
  };

  // Check if opening a shared link
  window.onload = () => {
    initCamera('environment');
    const params = new URLSearchParams(window.location.search);
    if(params.has('data')) {
      const data = JSON.parse(atob(params.get('data')));
      alert(`Viewing Shared Journey:\nDistance: ${data.d}km\nTime: ${data.t}`);
      if(data.loc) map.setView([data.loc.lat, data.loc.lng], 15);
    }
  };

  document.getElementById('startBtn').onclick = () => {
    startJourney();
    document.getElementById('startBtn').disabled = true;
    document.getElementById('stopBtn').disabled = false;
  };

  document.getElementById('stopBtn').onclick = stopJourney;

</script>
</body>
</html>
