
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Dual Live Tracker</title>
  <script src="https://cdn.ably.com/lib/ably.min-1.js"></script>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <style>
    :root { --me: #2563eb; --friend: #ef4444; --bg: #f8fafc; }
    body { font-family: sans-serif; margin: 0; background: var(--bg); overflow-x: hidden; }
    .container { max-width: 600px; margin: auto; padding: 10px; padding-bottom: 140px; }
    
    /* Stats Comparison */
    .dual-stats { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 10px; }
    .stat-card { background: white; padding: 10px; border-radius: 12px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); border-top: 4px solid #ddd; }
    .stat-card.me { border-color: var(--me); }
    .stat-card.friend { border-color: var(--friend); }
    .stat-card h4 { margin: 0 0 5px 0; font-size: 0.8em; color: #64748b; }
    .val { font-size: 1.2em; font-weight: bold; display: block; }

    #map { height: 400px; border-radius: 15px; border: 2px solid #fff; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
    
    .controls { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-top: 10px; }
    button { padding: 12px; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; color: white; }
    .btn-blue { background: var(--me); }
    .btn-red { background: #dc2626; }
    .btn-gray { background: #475569; }
    .btn-view { background: #059669; grid-column: span 2; }

    /* Chat Overlay */
    #chat-overlay { position: fixed; bottom: 110px; left: 10px; right: 10px; pointer-events: none; display: flex; flex-direction: column; gap: 5px; }
    .msg { background: rgba(255,255,255,0.95); padding: 10px; border-radius: 10px; box-shadow: 0 2px 8px rgba(0,0,0,0.2); width: fit-content; max-width: 80%; pointer-events: auto; }
    .my-msg { align-self: flex-end; border-right: 4px solid var(--me); }
    .f-msg { align-self: flex-start; border-left: 4px solid var(--friend); }

    .input-bar { position: fixed; bottom: 0; left: 0; right: 0; background: white; padding: 10px; display: flex; gap: 5px; box-shadow: 0 -2px 10px rgba(0,0,0,0.1); }
    input { flex: 1; padding: 10px; border-radius: 20px; border: 1px solid #ccc; }
  </style>
</head>
<body>

<div class="container">
  <div class="dual-stats">
    <div class="stat-card me">
      <h4>YOU</h4>
      <span class="val"><span id="mySpeed">0</span> km/h</span>
      <small id="myDist">0.0</small> km
    </div>
    <div class="stat-card friend">
      <h4>FRIEND</h4>
      <span class="val"><span id="fSpeed">0</span> km/h</span>
      <small id="fDist">0.0</small> km
    </div>
  </div>

  <div id="map"></div>

  <div class="controls">
    <button class="btn-blue" id="startBtn" onclick="startJourney()">üõ∞Ô∏è Start My Journey</button>
    <button class="btn-gray" onclick="copyLink()">üîó Invite Friend</button>
    <button class="btn-view" onclick="toggleCameraFocus()">üé• View: Auto (Both)</button>
    <button class="btn-red" onclick="location.reload()">üõë Reset</button>
  </div>
</div>

<div id="chat-overlay"></div>
<div class="input-bar">
  <input type="text" id="chatInput" placeholder="Live chat..." onkeypress="if(event.key==='Enter') sendChat()">
  <button class="btn-blue" onclick="sendChat()" style="border-radius: 20px;">Send</button>
</div>

<script>
  const ABLY_KEY = 'tQeHYQ.ZsPdVg:oHH2d2amT9WrziD8QOrjuZppajh6ijgZZiQ-GsgysUU';
  let ably, channel, myId, tripId;
  let myPos = null, friendPos = null;
  let myDist = 0, lastPos = null;
  let viewMode = 'both'; // 'me', 'friend', 'both'

  // 1. Setup Session
  const urlParams = new URLSearchParams(window.location.search);
  tripId = urlParams.get('t') || "trip_" + Math.random().toString(36).substr(2, 5);
  myId = Math.random().toString(36).substr(2, 3); // Unique ID for this driver

  // 2. Initialize Map
  const map = L.map('map').setView([0,0], 2);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

  const myPath = L.polyline([], {color: '#2563eb', weight: 5}).addTo(map);
  const friendPath = L.polyline([], {color: '#ef4444', weight: 5, dashArray: '5, 10'}).addTo(map);
  const myMarker = L.circleMarker([0,0], {radius: 8, fillColor: '#2563eb', color: '#fff', fillOpacity: 1}).addTo(map);
  const friendMarker = L.circleMarker([0,0], {radius: 8, fillColor: '#ef4444', color: '#fff', fillOpacity: 1}).addTo(map);

  // 3. Setup Communication
  ably = new Ably.Realtime(ABLY_KEY);
  channel = ably.channels.get(tripId);

  channel.subscribe('move', (msg) => {
    if(msg.data.id === myId) return; // Skip my own messages
    updateFriendUI(msg.data);
  });

  channel.subscribe('chat', (msg) => {
    showChat(msg.data.id === myId ? 'me' : 'friend', msg.data.txt);
  });

  // 4. Core Functions
  function startJourney() {
    document.getElementById('startBtn').disabled = true;
    document.getElementById('startBtn').innerText = "üì° Broadcasting...";
    
    navigator.geolocation.watchPosition(pos => {
      const { latitude, longitude, speed } = pos.coords;
      const s = speed ? (speed * 3.6).toFixed(1) : 0;
      
      if(lastPos) {
        myDist += calcDist(lastPos.lat, lastPos.lng, latitude, longitude);
      }
      lastPos = {lat: latitude, lng: longitude};
      myPos = [latitude, longitude];

      // Update Local UI
      document.getElementById('mySpeed').innerText = s;
      document.getElementById('myDist').innerText = myDist.toFixed(2);
      myMarker.setLatLng(myPos);
      myPath.addLatLng(myPos);
      
      autoZoom();

      // Broadcast to Friend
      channel.publish('move', { id: myId, lat: latitude, lng: longitude, s: s, d: myDist.toFixed(2) });
    }, null, {enableHighAccuracy: true});
  }

  function updateFriendUI(data) {
    friendPos = [data.lat, data.lng];
    document.getElementById('fSpeed').innerText = data.s;
    document.getElementById('fDist').innerText = data.d;
    friendMarker.setLatLng(friendPos);
    friendPath.addLatLng(friendPos);
    autoZoom();
  }

  function autoZoom() {
    if (viewMode === 'me' && myPos) map.setView(myPos, 16);
    else if (viewMode === 'friend' && friendPos) map.setView(friendPos, 16);
    else if (viewMode === 'both') {
      const points = [];
      if(myPos) points.push(myPos);
      if(friendPos) points.push(friendPos);
      if(points.length > 0) map.fitBounds(L.latLngBounds(points), {padding: [50, 50]});
    }
  }

  function toggleCameraFocus() {
    const modes = ['both', 'me', 'friend'];
    viewMode = modes[(modes.indexOf(viewMode) + 1) % modes.length];
    const labels = { 'both': 'üé• View: Auto (Both)', 'me': 'üé• View: Only Me', 'friend': 'üé• View: Only Friend' };
    event.target.innerText = labels[viewMode];
    autoZoom();
  }

  function sendChat() {
    const inp = document.getElementById('chatInput');
    if(!inp.value) return;
    channel.publish('chat', { id: myId, txt: inp.value });
    inp.value = '';
  }

  function showChat(side, txt) {
    const container = document.getElementById('chat-overlay');
    // Clear screen on reply logic
    if (container.children.length > 0) container.innerHTML = ''; 
    
    const div = document.createElement('div');
    div.className = `msg ${side === 'me' ? 'my-msg' : 'f-msg'}`;
    div.innerHTML = `<strong>${side === 'me' ? 'You' : 'Friend'}:</strong><br>${txt}`;
    container.appendChild(div);
  }

  function calcDist(lat1, lon1, lat2, lon2) {
    const R = 6371;
    const dLat = (lat2-lat1)*Math.PI/180;
    const dLon = (lon2-lon1)*Math.PI/180;
    const a = Math.sin(dLat/2)**2 + Math.cos(lat1*Math.PI/180)*Math.cos(lat2*Math.PI/180)*Math.sin(dLon/2)**2;
    return 2 * R * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
  }

  function copyLink() {
    const link = `${window.location.origin}${window.location.pathname}?t=${tripId}`;
    navigator.clipboard.writeText(link);
    alert("Share this link with your friend. When they start their journey, you will see each other!");
  }
</script>
</body>
</html>
