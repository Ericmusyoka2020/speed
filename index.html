<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Dual Driver Live Tracker</title>
  <script src="https://cdn.ably.com/lib/ably.min-1.js"></script>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <style>
    :root { --primary: #2563eb; --driver1: #ef4444; --driver2: #059669; --bg: #f8fafc; }
    body { font-family: sans-serif; margin: 0; background: var(--bg); overflow-x: hidden; }
    header { background: #1e293b; color: white; padding: 10px; text-align: center; font-size: 0.8em; }
    
    .setup-screen { position: fixed; inset: 0; background: white; z-index: 2000; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 20px; }
    input[type="text"] { padding: 12px; width: 80%; border: 2px solid #e2e8f0; border-radius: 8px; margin-bottom: 10px; font-size: 16px; }

    .container { padding: 10px; padding-bottom: 160px; }
    #map { height: 300px; border-radius: 15px; margin-bottom: 10px; border: 2px solid #ddd; }
    
    .stats-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 10px; }
    .card { background: white; padding: 10px; border-radius: 10px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); text-align: center; }
    .card b { display: block; font-size: 1.2em; color: var(--primary); }

    .controls { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
    button { padding: 12px; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; color: white; transition: 0.2s; }
    button:active { opacity: 0.8; }
    
    .btn-go { background: var(--driver2); grid-column: span 2; }
    .btn-req { background: #f59e0b; }
    .btn-view { background: #6366f1; }
    .btn-stop { background: #ef4444; }

    #chat-overlay { position: fixed; bottom: 80px; left: 10px; right: 10px; pointer-events: none; }
    .msg { background: white; padding: 8px 12px; border-radius: 10px; margin-top: 5px; width: fit-content; box-shadow: 0 2px 8px rgba(0,0,0,0.1); border-left: 4px solid var(--primary); pointer-events: auto; }
  
    .chat-bar { position: fixed; bottom: 0; left: 0; right: 0; padding: 10px; background: white; display: flex; gap: 5px; border-top: 1px solid #ddd; }
    .chat-bar input { flex: 1; padding: 10px; border-radius: 5px; border: 1px solid #ccc; }
  </style>
</head>
<body>

<div id="setup" class="setup-screen">
  <h2>Enter Driver Name</h2>
  <input type="text" id="userName" placeholder="Your Name (e.g. John)">
  <button class="btn-go" onclick="startApp()" style="width: 85%">Join Journey</button>
  <p style="font-size: 0.8em; color: #666; margin-top: 20px;">Share the URL with your friend to track together.</p>
</div>

<header>
  <div id="roleDisplay">Waiting for connection...</div>
</header>

<div class="container">
  <div id="map"></div>

  <div class="stats-grid">
    <div class="card"><span>My Speed</span><b id="mySpeed">0</b></div>
    <div class="card"><span>Friend Speed</span><b id="friendSpeed">0</b></div>
    <div class="card" style="grid-column: span 2;"><span>Status</span><b id="status" style="font-size: 0.9em;">Ready</b></div>
  </div>

  <div class="controls">
    <button class="btn-go" id="startBtn" onclick="toggleGPS()">ðŸš€ Start My Journey</button>
    <button class="btn-req" onclick="requestFriend()">ðŸ”” Request Friend Start</button>
    <button class="btn-view" id="viewToggle" onclick="toggleView()">ðŸ‘€ Viewing: Me</button>
    <button class="btn-stop" onclick="location.reload()">ðŸ”„ Reset</button>
  </div>
</div>

<div id="chat-overlay"></div>
<div class="chat-bar">
  <input type="text" id="chatInput" placeholder="Message friend...">
  <button class="btn-go" style="padding: 10px 20px;" onclick="sendChat()">Send</button>
</div>

<script>
  const ABLY_KEY = 'tQeHYQ.ZsPdVg:oHH2d2amT9WrziD8QOrjuZppajh6ijgZZiQ-GsgysUU';
  let ably, channel, myName, watchId;
  let viewFocus = "me"; // "me" or "friend"
  let markers = {}; 
  let paths = {};

  const params = new URLSearchParams(window.location.search);
  const tripId = params.get('trip') || "shared_" + Math.random().toString(36).substr(2, 5);

  const map = L.map('map').setView([0,0], 2);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

  function startApp() {
    myName = document.getElementById('userName').value.trim();
    if(!myName) return alert("Enter a name");
    document.getElementById('setup').style.display = 'none';
    document.getElementById('roleDisplay').innerText = `ID: ${tripId} | Driver: ${myName}`;
    
    initAbly();
    if(!params.has('trip')) {
        const link = window.location.href.split('?')[0] + '?trip=' + tripId;
        console.log("Share this link:", link);
    }
  }

  function initAbly() {
    ably = new Ably.Realtime(ABLY_KEY);
    channel = ably.channels.get(tripId);

    // Listen for friend's movement
    channel.subscribe('pos_update', (msg) => {
      if(msg.data.name === myName) return;
      updateFriendUI(msg.data);
    });

    // Listen for start requests
    channel.subscribe('request_start', (msg) => {
      if(msg.data.to === myName) {
        showFlashMsg(`ðŸš¨ ${msg.data.from} requested you to start your movement!`);
      }
    });

    // Listen for chat
    channel.subscribe('chat', (msg) => {
      showFlashMsg(`<b>${msg.data.from}:</b> ${msg.data.txt}`);
    });
  }

  function toggleGPS() {
    const btn = document.getElementById('startBtn');
    btn.disabled = true;
    btn.innerText = "ðŸ›°ï¸ Journey Live";
    btn.style.background = "#94a3b8";

    watchId = navigator.geolocation.watchPosition(pos => {
      const { latitude, longitude, speed } = pos.coords;
      const s = speed ? (speed * 3.6).toFixed(1) : 0;
      
      document.getElementById('mySpeed').innerText = s;
      updateMarker(myName, latitude, longitude, '#2563eb');
      
      if(viewFocus === 'me') map.setView([latitude, longitude], 15);

      channel.publish('pos_update', { name: myName, lat: latitude, lng: longitude, speed: s });
    }, null, {enableHighAccuracy: true});
  }

  function updateFriendUI(data) {
    document.getElementById('friendSpeed').innerText = data.speed;
    updateMarker(data.name, data.lat, data.lng, '#ef4444');
    
    if(viewFocus === 'friend') {
        map.setView([data.lat, data.lng], 15);
    }
  }

  function updateMarker(name, lat, lng, color) {
    if(!markers[name]) {
      markers[name] = L.circleMarker([lat, lng], {radius: 10, color: 'white', fillColor: color, fillOpacity: 1, weight: 3}).addTo(map).bindPopup(name);
      paths[name] = L.polyline([], {color: color, weight: 4}).addTo(map);
    }
    const newPos = [lat, lng];
    markers[name].setLatLng(newPos);
    paths[name].addLatLng(newPos);
  }

  function toggleView() {
    viewFocus = (viewFocus === 'me') ? 'friend' : 'me';
    document.getElementById('viewToggle').innerText = `ðŸ‘€ Viewing: ${viewFocus.toUpperCase()}`;
  }

  function requestFriend() {
    channel.publish('request_start', { from: myName, to: 'friend' });
    showFlashMsg("Sent request to friend!");
  }

  function sendChat() {
    const input = document.getElementById('chatInput');
    if(!input.value) return;
    channel.publish('chat', { from: myName, txt: input.value });
    input.value = '';
  }

  function showFlashMsg(html) {
    const container = document.getElementById('chat-overlay');
    const el = document.createElement('div');
    el.className = 'msg';
    el.innerHTML = html;
    container.appendChild(el);
    setTimeout(() => el.remove(), 5000);
  }
</script>
</body>
</html>
